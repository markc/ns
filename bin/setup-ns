#!/usr/bin/env bash
# Created: 20170319 - Updated: 20250125
# Copyright (C) 1995-2025 Mark Constable <mc@netserva.org> (MIT License)

# NetServa deployment installer script
# Installs the NetServa management system from GitHub

NSDIR="$HOME/.ns"
NSREPO="https://github.com/markc/ns"

if [[ -d "$NSDIR" && -d "$NSDIR/.git" ]]; then
    echo "Updating NetServa scripts..."
    cd "$NSDIR" || exit 1
    git pull --rebase=false
    echo "NetServa updated successfully"
elif [[ -d "$NSDIR" ]]; then
    echo "Warning: $NSDIR exists but is not a git repository"
    echo "Please remove $NSDIR and run this script again, or manually update"
    exit 1
elif [[ ! -e /usr/bin/git ]]; then
    echo "Error: git is not installed. Please install git first." >&2
    exit 1
else
    echo "Installing NetServa scripts..."
    git clone -q --depth 1 "$NSREPO" "$NSDIR" || {
        echo "Error: Failed to clone repository" >&2
        exit 1
    }
    
    # Make scripts executable
    find "$NSDIR/bin" -type f -exec chmod +x {} \;
    
    # Initialize SSH manager if needed
    if [[ -x "$NSDIR/bin/sshm" ]]; then
        "$NSDIR/bin/sshm" init
    fi
    
    # Set up shell initialization
    if ! grep -q "source $NSDIR/lib/nsrc.sh" ~/.bashrc 2>/dev/null; then
        echo "" >> ~/.bashrc
        echo "# NetServa initialization" >> ~/.bashrc
        echo "[[ -f $NSDIR/lib/nsrc.sh ]] && source $NSDIR/lib/nsrc.sh" >> ~/.bashrc
    fi
    
    echo "NetServa installed successfully!"
    echo "Run 'source ~/.bashrc' to initialize the environment"
    echo "Then use 'ns help' to see available commands"
fi
